pipeline { 
    agent {
        label 'chef'
        }
        stages { 
            stage ('Checkout') {
                steps{
                     cleanWs()
                    checkout changelog: false, poll: false, scm: [$class: 'GitSCM', branches: [[name: 'main']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/abhisheknipun1/chef_objects.git']]]
                }
            }
            stage ('Environment Upload') { 
                steps {
                    dir('/home/ec2-user/chef-repo/') {
                       sh 'pwd'
                        sh 'knife download environments'
                    }
                    sh 'cp -r $WORKSPACE/* /home/ec2-user/chef-repo/environments'
                    dir('/home/ec2-user/chef-repo/environments') {
                        sh 'pwd'
                        sh 'knife upload environment/*'
                        sh 'knife node node1 environment _default dev'
                        sh 'knife node node2 environment _default stage'                        
                     }
                }
         }
     }
}
