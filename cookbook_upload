pipeline { 
    agent {
        label 'chef'
        }
        stages { 
            stage ('Checkout') {
                steps{
                     cleanWs()
                    checkout changelog: false, poll: false, scm: [$class: 'GitSCM', branches: [[name: '${branch}']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/abhisheknipun1/${CookbookName}.git']]]
                }
            }
            stage ('Cookbook Upload') { 
                steps { 
                    script{
                    sh 'pwd;ls'
                    
                    sh 'ls -lrt /home/ec2-user/chef-repo/cookbooks'
                    if (fileExists('/home/ec2-user/chef-repo/cookbooks/${CookbookName')) {
                        sh 'rm -r /home/ec2-user/chef-repo/cookbooks/${CookbookName}'
                        }
                    sh 'ls -lrt /home/ec2-user/chef-repo/cookbooks'
                    sh 'cp $WORKSPACE/${CookbookName} /home/ec2-user/chef-repo/cookbooks'
                    dir('/home/ec2-user/chef-repo/cookbooks') {
                        sh 'pwd'
                        sh 'knife upload ${CookbookName}'
                        }
                     }
                }
         }
     }
}
                        
